name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  checks: write
  statuses: write

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      golang: ${{ steps.filter.outputs.golang }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            golang:
              - '**.go'
              - 'go.mod'
              - 'go.sum'
              - 'Taskfile.yml'

  golang:
    needs: changes
    if: needs.changes.outputs.golang == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: '1.26'
      - uses: arduino/setup-task@v2
        with:
          version: '3.x'
      - name: Install tools
        run: |
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          go install gotest.tools/gotestsum@latest
      - run: task fmt
        name: Format check
      - run: task vet
        name: Vet
      - run: task lint
        name: Lint
      - run: task test
        name: Unit tests
      - run: task coverage
        name: Coverage check
      - run: task build
        name: Build
      - name: Unit test check run
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const file = 'unit-results.xml';
            if (!fs.existsSync(file)) {
              core.warning('unit-results.xml not found, skipping check run');
              return;
            }
            const xml = fs.readFileSync(file, 'utf8');
            const tests = parseInt(xml.match(/tests="(\d+)"/)?.[1] || '0');
            const failures = parseInt(xml.match(/failures="(\d+)"/)?.[1] || '0');
            const errors = parseInt(xml.match(/errors="(\d+)"/)?.[1] || '0');
            const skipped = (xml.match(/<skipped/g) || []).length;
            const passed = tests - failures - errors - skipped;
            const time = xml.match(/time="([\d.]+)"/)?.[1] || '0';
            const conclusion = (failures > 0 || errors > 0) ? 'failure' : 'success';
            const sha = context.payload.pull_request?.head?.sha || context.sha;
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Unit Test Results',
              head_sha: sha,
              status: 'completed',
              conclusion,
              output: {
                title: `${passed} passed, ${failures} failed, ${skipped} skipped`,
                summary: [
                  `**${tests}** tests completed in **${time}s**`,
                  '',
                  '| Metric | Count |',
                  '| --- | --- |',
                  `| Passed | ${passed} |`,
                  `| Failed | ${failures} |`,
                  `| Skipped | ${skipped} |`,
                ].join('\n'),
              },
            });
      - name: Test summary
        if: always()
        run: |
          {
            echo "## Unit Test Results"
            echo ""
            if [ ! -f unit-results.xml ]; then
              echo "> No results file found"
            else
              line=$(head -5 unit-results.xml | tr '\n' ' ')
              tests=$(echo "$line" | grep -oP 'tests="\K[0-9]+' | head -1)
              failures=$(echo "$line" | grep -oP 'failures="\K[0-9]+' | head -1)
              errors=$(echo "$line" | grep -oP 'errors="\K[0-9]+' | head -1)
              skipped=$(grep -c '<skipped' unit-results.xml 2>/dev/null) || true
              skipped=${skipped:-0}
              tests=${tests:-0}
              failures=${failures:-0}
              errors=${errors:-0}
              passed=$((tests - failures - errors - skipped))
              echo "| Metric | Count |"
              echo "| --- | --- |"
              echo "| Total | $tests |"
              echo "| Passed | $passed |"
              echo "| Failed | $failures |"
              echo "| Skipped | $skipped |"
            fi
            echo ""
            echo "## Coverage"
            echo ""
            if [ ! -f coverage.out ]; then
              echo "> No coverage data found"
            else
              total=$(go tool cover -func=coverage.out | grep '^total:' | awk '{print $3}')
              echo "| Metric | Value |"
              echo "| --- | --- |"
              echo "| Coverage | $total |"
              echo "| Threshold | 85% |"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Coverage commit status
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ ! -f coverage.out ]; then
            echo "No coverage data, skipping status"
            exit 0
          fi
          total=$(go tool cover -func=coverage.out | grep '^total:' | awk '{print $3}' | tr -d '%')
          threshold=85
          state="success"
          if [ "$(echo "$total < $threshold" | bc -l)" -eq 1 ]; then
            state="failure"
          fi
          sha="${{ github.event.pull_request.head.sha || github.sha }}"
          gh api "/repos/${{ github.repository }}/statuses/${sha}" \
            -f state="$state" \
            -f description="${total}% (threshold: ${threshold}%)" \
            -f context="coverage"

  commit-standards:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Validate commits
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
          ERRORS=0
          while IFS= read -r sha; do
            MSG=$(git log --format='%s' -n 1 "$sha")
            if echo "$MSG" | grep -qE '^Merge '; then continue; fi
            if ! echo "$MSG" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+'; then
              echo "FAIL [$sha]: Not conventional commit: $MSG"
              ERRORS=$((ERRORS + 1))
            fi
            if [ ${#MSG} -gt 72 ]; then
              echo "WARN [$sha]: Subject > 72 chars: $MSG"
            fi
          done < <(git rev-list "$BASE".."$HEAD")
          if [ $ERRORS -gt 0 ]; then exit 1; fi

  summary:
    if: always()
    needs: [changes, golang, commit-standards]
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.golang.result }}" == "failure" ]]; then exit 1; fi
          if [[ "${{ needs.commit-standards.result }}" == "failure" ]]; then exit 1; fi
          echo "golang: ${{ needs.golang.result }}"
          echo "commits: ${{ needs.commit-standards.result }}"
          echo "All checks passed."
