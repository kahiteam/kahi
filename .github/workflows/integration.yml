name: Integration

on:
  push:
    branches: [main]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'Taskfile.yml'
  pull_request:
    branches: [main]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'Taskfile.yml'

permissions:
  contents: read
  checks: write

jobs:
  integration:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: '1.26'
      - uses: arduino/setup-task@v2
        with:
          version: '3.x'
      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest
      - run: task test-integration
        name: Integration tests
      - run: task test-e2e
        name: E2E tests
      - name: Integration test check run
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            async function createCheckRun(file, name) {
              if (!fs.existsSync(file)) {
                core.warning(`${file} not found, skipping check run`);
                return;
              }
              const xml = fs.readFileSync(file, 'utf8');
              const tests = parseInt(xml.match(/tests="(\d+)"/)?.[1] || '0');
              const failures = parseInt(xml.match(/failures="(\d+)"/)?.[1] || '0');
              const errors = parseInt(xml.match(/errors="(\d+)"/)?.[1] || '0');
              const skipped = (xml.match(/<skipped/g) || []).length;
              const passed = tests - failures - errors - skipped;
              const time = xml.match(/time="([\d.]+)"/)?.[1] || '0';
              const conclusion = (failures > 0 || errors > 0) ? 'failure' : 'success';
              const sha = context.payload.pull_request?.head?.sha || context.sha;
              await github.rest.checks.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name,
                head_sha: sha,
                status: 'completed',
                conclusion,
                output: {
                  title: `${passed} passed, ${failures} failed, ${skipped} skipped`,
                  summary: [
                    `**${tests}** tests completed in **${time}s**`,
                    '',
                    '| Metric | Count |',
                    '| --- | --- |',
                    `| Passed | ${passed} |`,
                    `| Failed | ${failures} |`,
                    `| Skipped | ${skipped} |`,
                  ].join('\n'),
                },
              });
            }
            await createCheckRun('integration-results.xml', 'Integration Test Results');
            await createCheckRun('e2e-results.xml', 'E2E Test Results');
      - name: Test summary
        if: always()
        run: |
          parse_junit() {
            local file="$1"
            local suite="$2"
            if [ ! -f "$file" ]; then
              echo "| $suite | - | - | - | - | No results file found |"
              return
            fi
            local line tests failures errors skipped passed status
            line=$(head -5 "$file" | tr '\n' ' ')
            tests=$(echo "$line" | grep -oP 'tests="\K[0-9]+' | head -1)
            failures=$(echo "$line" | grep -oP 'failures="\K[0-9]+' | head -1)
            errors=$(echo "$line" | grep -oP 'errors="\K[0-9]+' | head -1)
            skipped=$(grep -c '<skipped' "$file" 2>/dev/null) || true
            skipped=${skipped:-0}
            tests=${tests:-0}
            failures=${failures:-0}
            errors=${errors:-0}
            passed=$((tests - failures - errors - skipped))
            status="Pass"
            if [ "$failures" -gt 0 ] || [ "$errors" -gt 0 ]; then
              status="FAIL"
            fi
            echo "| $suite | $tests | $passed | $failures | $skipped | $status |"
          }
          {
            echo "## Test Results"
            echo ""
            echo "| Suite | Total | Passed | Failed | Skipped | Status |"
            echo "| --- | --- | --- | --- | --- | --- |"
            parse_junit integration-results.xml "Integration"
            parse_junit e2e-results.xml "E2E"
          } >> "$GITHUB_STEP_SUMMARY"
